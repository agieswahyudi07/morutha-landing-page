---
import Navigation from '../../components/Navigation.astro';
import Logo from '../../components/Logo.astro';
import { Image } from 'astro:assets';
import { 
  ChevronRight, 
  Image as ImageIcon, 
  Maximize, 
  ArrowUpRight, 
  MessageCircle, 
  ArrowRight,
  X,
  ChevronLeft,
  Instagram
} from '@lucide/astro';
import { PRODUCT_SERIES, getProductBySeries } from '../../data/products';
import '../../styles/global.css';

export async function getStaticPaths() {
  return PRODUCT_SERIES.map((series) => ({
    params: { seriesId: series.id },
  }));
}

const { seriesId } = Astro.params;
const series = getProductBySeries(seriesId!);

if (!series) {
  return Astro.redirect('/products');
}

// Get color from URL query params, or use featured color
const url = Astro.url;
const colorParam = url.searchParams.get('color');
const selectedColorId = colorParam || series.colorVariants.find(v => v.id.includes(series.featuredColor || ''))?.id || series.colorVariants[0].id;
const selectedVariant = series.colorVariants.find(v => v.id === selectedColorId) || series.colorVariants[0];
const currentImageIndex = 0; // Start with first image

// Prepare variant data for client-side switching
// We'll extract image URLs from the rendered images in the DOM
// For now, store variant info - images will be extracted from DOM
const variantData = series.colorVariants.map(variant => ({
  id: variant.id,
  name: variant.name,
  imageCount: variant.images.length,
}));
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/webp" href="/logo.webp" />
    <link rel="apple-touch-icon" href="/logo.webp" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={`${series.name} - ${series.description}. Tersedia dalam ${series.colorVariants.length} varian warna.`} />
    <title>{series.name} - Morutha</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  </head>
  <body class="min-h-screen flex flex-col text-gray-800 overflow-x-hidden">
    <Navigation />
    
    <!-- Breadcrumb -->
    <section class="bg-gray-50 py-4 border-b border-gray-100">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <a href="/" class="hover:text-[#00a8a8] transition-colors">Beranda</a>
          <ChevronRight size={16} />
          <a href="/products" class="hover:text-[#00a8a8] transition-colors">Produk</a>
          <ChevronRight size={16} />
          <span class="text-gray-900 font-medium">{series.name}</span>
        </div>
      </div>
    </section>

    <!-- Product Detail - Enhanced Layout -->
    <section class="py-4 sm:py-6 lg:py-12 bg-white">
      <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
        <div class="grid lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-16 items-start">
          <!-- Product Images - Enhanced -->
          <div class="lg:sticky lg:top-24 space-y-2 sm:space-y-3 lg:space-y-4">
            <!-- Main Hero Image - Large -->
            <div class="relative group">
              <div class="aspect-square bg-gray-50 rounded-xl sm:rounded-2xl lg:rounded-3xl overflow-hidden p-3 sm:p-4 lg:p-12 flex items-center justify-center shadow-lg">
                {selectedVariant.images.length > 0 ? (
                  <div id="main-image-container" class="w-full h-full relative">
                    {/* Render all variant images, show only selected variant */}
                    {series.colorVariants.map((variant) => (
                      variant.images.map((img, idx) => (
                        <Image 
                          src={img}
                          alt={`${series.name} - ${variant.name} - Image ${idx + 1}`}
                          width={1000}
                          height={1000}
                          class={`w-full h-full object-contain transition-opacity duration-300 main-variant-image absolute inset-0 ${
                            variant.id === selectedVariant.id && idx === 0 
                              ? 'opacity-100 relative' 
                              : variant.id === selectedVariant.id 
                                ? 'opacity-0' 
                                : 'opacity-0 hidden'
                          }`}
                          data-image-index={idx}
                          data-variant-id={variant.id}
                          loading={variant.id === selectedVariant.id && idx === 0 ? "eager" : "lazy"}
                          format="webp"
                          quality={90}
                        />
                      ))
                    ))}
                  </div>
                ) : selectedVariant.featuredImage ? (
                  <Image 
                    src={selectedVariant.featuredImage}
                    alt={`${series.name} - ${selectedVariant.name}`}
                    width={1000}
                    height={1000}
                    class="w-full h-full object-contain"
                    loading="eager"
                    format="webp"
                    quality={90}
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-gray-400">
                    <ImageIcon size={64} />
                  </div>
                )}
              </div>
              
              <!-- Image Zoom Indicator -->
              <button 
                id="lightbox-trigger"
                class="absolute bottom-4 right-4 bg-white/90 backdrop-blur-sm p-2.5 sm:p-3 rounded-full shadow-lg hover:bg-white transition-all opacity-100 lg:opacity-0 lg:group-hover:opacity-100"
                aria-label="Lihat fullscreen"
              >
                <Maximize size={18} class="sm:w-5 sm:h-5 text-gray-700" />
              </button>
            </div>
            
            <!-- Photo Gallery Thumbnails - Enhanced -->
            <div id="thumbnail-container" class="space-y-1.5 sm:space-y-2" style={selectedVariant.images.length <= 1 ? 'display: none;' : ''}>
              <p class="text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2">Semua Foto (<span id="thumbnail-count">{selectedVariant.images.length}</span>)</p>
              <div id="thumbnail-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-1.5 sm:gap-2">
                {/* Render all variant thumbnails, show only selected variant */}
                {series.colorVariants.map((variant) => (
                  variant.images.map((img, idx) => (
                    <button 
                      class={`aspect-square bg-gray-50 rounded-xl overflow-hidden p-1.5 hover:ring-2 ring-[#00a8a8] transition-all group/image-thumb thumbnail-btn ${
                        variant.id === selectedVariant.id ? '' : 'hidden'
                      }`}
                      data-image-index={idx}
                      data-variant-id={variant.id}
                      aria-label={`View image ${idx + 1}`}
                    >
                      <Image 
                        src={img}
                        alt={`${series.name} - ${variant.name} - Thumbnail ${idx + 1}`}
                        width={200}
                        height={200}
                        class="w-full h-full object-contain group-hover/image-thumb:scale-110 transition-transform"
                        loading="lazy"
                        format="webp"
                        quality={80}
                      />
                    </button>
                  ))
                ))}
              </div>
            </div>
          </div>

          <!-- Product Info - Enhanced -->
          <div class="space-y-3 sm:space-y-4 lg:space-y-8 mt-4 sm:mt-6 lg:mt-0">
            {series.tag && (
              <span class="inline-block bg-orange-400 text-white text-[10px] sm:text-xs font-bold px-3 sm:px-4 py-1 sm:py-1.5 rounded-full">
                {series.tag}
              </span>
            )}
            
            <div>
              <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-6xl font-extrabold text-gray-900 mb-2 sm:mb-3 lg:mb-4 leading-tight">{series.name}</h1>
              <p class="text-sm sm:text-base lg:text-xl text-gray-600 leading-relaxed">{series.description}</p>
            </div>

            <!-- Price hidden temporarily -->
            <!-- <div class="flex items-baseline gap-3 pb-4 border-b border-gray-200">
              <span class="text-4xl lg:text-5xl font-bold text-[#00a8a8]">
                IDR {(series.price / 1000).toFixed(0)}k
              </span>
            </div> -->

            <!-- Color Variants - Enhanced Horizontal Scrollable -->
            <div class="space-y-2.5 sm:space-y-3 lg:space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="text-sm sm:text-base lg:text-lg font-bold text-gray-900">Warna Tersedia</h3>
                <span class="text-[10px] sm:text-xs lg:text-sm text-gray-500">{series.colorVariants.length} varian</span>
              </div>
              
              <!-- Horizontal Scrollable Color Selector -->
              <div class="overflow-x-auto pb-1.5 sm:pb-2 -mx-1 sm:-mx-2 px-1 sm:px-2 scrollbar-hide">
                <div class="flex gap-2 sm:gap-3 min-w-max">
                  {series.colorVariants.map((variant) => (
                    <button
                      type="button"
                      data-variant-id={variant.id}
                      class={`flex-shrink-0 px-3 sm:px-4 lg:px-5 py-1.5 sm:py-2 lg:py-2.5 rounded-full border-2 transition-all whitespace-nowrap color-variant-btn text-xs sm:text-sm lg:text-base ${
                        selectedVariant.id === variant.id
                          ? 'border-[#00a8a8] bg-teal-50 text-[#00a8a8] font-bold shadow-md scale-105'
                          : 'border-gray-200 hover:border-[#00a8a8] text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      {variant.name}
                    </button>
                  ))}
                </div>
              </div>
              
              <!-- Selected Color Info -->
              <div id="color-info" class="bg-teal-50/50 rounded-lg sm:rounded-xl lg:rounded-2xl p-2.5 sm:p-3 lg:p-4 border border-teal-100">
                <p class="text-[11px] sm:text-xs lg:text-sm text-gray-600">
                  <span class="font-semibold text-gray-900" id="selected-color-name">{selectedVariant.name}</span> - <span id="selected-color-count">{selectedVariant.images.length}</span> foto tersedia
                </p>
              </div>
            </div>

            <!-- CTA Buttons - Enhanced -->
            <div class="flex flex-col sm:flex-row gap-2.5 sm:gap-3 lg:gap-4 pt-3 sm:pt-4">
              <a 
                href="https://shopee.co.id/morutha.id" 
                target="_blank"
                rel="noopener noreferrer"
                class="flex-1 bg-[#00a8a8] hover:bg-[#008a8a] text-white px-4 sm:px-6 lg:px-8 py-2.5 sm:py-3 lg:py-4 rounded-full font-bold flex items-center justify-center gap-1.5 sm:gap-2 transition-all shadow-lg hover:-translate-y-0.5 hover:shadow-xl text-xs sm:text-sm lg:text-base"
              >
                <ArrowUpRight size={16} class="sm:w-[18px] sm:h-[18px] lg:w-5 lg:h-5" />
                Beli di Shopee
              </a>
              <a 
                href="https://wa.me/6288220168168" 
                target="_blank"
                rel="noopener noreferrer"
                class="flex-1 bg-[#25D366] hover:bg-[#128C7E] text-white px-4 sm:px-6 lg:px-8 py-2.5 sm:py-3 lg:py-4 rounded-full font-bold flex items-center justify-center gap-1.5 sm:gap-2 transition-all shadow-lg hover:-translate-y-0.5 hover:shadow-xl text-xs sm:text-sm lg:text-base"
              >
                <MessageCircle size={16} class="sm:w-[18px] sm:h-[18px] lg:w-5 lg:h-5" />
                Hubungi WhatsApp
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- All Color Variants Gallery - Enhanced -->
    <section class="py-16 lg:py-20 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6 sm:mb-8">
          <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900">Semua Varian Warna</h2>
          <span class="text-gray-500 font-medium text-sm sm:text-base">{series.colorVariants.length} warna tersedia</span>
        </div>
        
        <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
          {series.colorVariants.map((variant) => (
            <button
              type="button"
              data-variant-id={variant.id}
              class={`group bg-white rounded-3xl overflow-hidden shadow-sm hover:shadow-xl transition-all fade-in variant-gallery-card text-left w-full ${
                selectedVariant.id === variant.id ? 'ring-2 ring-[#00a8a8]' : ''
              }`}
            >
              <div class="aspect-square bg-gray-50 p-6 relative">
                {variant.featuredImage ? (
                  <Image 
                    src={variant.featuredImage}
                    alt={`${series.name} - ${variant.name}`}
                    width={600}
                    height={600}
                    class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-500"
                    loading="lazy"
                    format="webp"
                    quality={85}
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-gray-400">
                    <ImageIcon size={48} />
                  </div>
                )}
                {selectedVariant.id === variant.id && (
                  <div class="absolute top-3 right-3 bg-[#00a8a8] text-white text-xs font-bold px-2 py-1 rounded-full variant-selected-badge">
                    Dipilih
                  </div>
                )}
              </div>
              <div class="p-4 sm:p-6">
                <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-2">{variant.name}</h3>
                <p class="text-xs sm:text-sm text-gray-500 mb-3 sm:mb-4 flex items-center gap-2">
                  <ImageIcon size={12} class="sm:w-3.5 sm:h-3.5" />
                  {variant.images.length} foto
                </p>
                <div class="inline-flex items-center gap-1.5 sm:gap-2 text-[#00a8a8] font-bold group-hover:gap-2 sm:group-hover:gap-3 transition-all text-sm sm:text-base">
                  Lihat Semua Foto <ArrowRight size={14} class="sm:w-4 sm:h-4" />
                </div>
              </div>
            </button>
          ))}
        </div>
      </div>
    </section>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
      <button id="lightbox-close" class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors z-10">
        <X size={32} />
      </button>
      <button id="lightbox-prev" class="absolute left-4 text-white hover:text-gray-300 transition-colors z-10 bg-black/50 p-3 rounded-full">
        <ChevronLeft size={24} />
      </button>
      <button id="lightbox-next" class="absolute right-4 text-white hover:text-gray-300 transition-colors z-10 bg-black/50 p-3 rounded-full">
        <ChevronRight size={24} />
      </button>
      <div id="lightbox-image-container" class="max-w-6xl max-h-[90vh] w-full h-full flex items-center justify-center">
        <!-- Images will be inserted here -->
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 pt-20 pb-10 mt-auto">
      <div class="max-w-7xl mx-auto px-4 grid md:grid-cols-4 gap-12 mb-20">
        <div class="space-y-6">
          <Logo className="!items-start" />
          <p class="text-sm text-gray-400 font-medium leading-relaxed">
            Thoughtfully designed footwear for the most precious little feet.
          </p>
        </div>
        
        <div class="space-y-6">
          <h4 class="font-bold text-gray-900 uppercase tracking-widest text-[10px]">Belanja</h4>
          <ul class="space-y-4 text-sm font-medium text-gray-500">
            <li><a href="/products" class="hover:text-[#00a8a8] transition-colors">Semua Produk</a></li>
            <li><a href="/" class="hover:text-[#00a8a8] transition-colors">Beranda</a></li>
          </ul>
        </div>
        
        <div class="space-y-6">
          <h4 class="font-bold text-gray-900 uppercase tracking-widest text-[10px]">Bantuan</h4>
          <ul class="space-y-4 text-sm font-medium text-gray-500">
            <li><a href="#" class="hover:text-[#00a8a8] transition-colors">Panduan Ukuran</a></li>
            <li><a href="#" class="hover:text-[#00a8a8] transition-colors">FAQ</a></li>
          </ul>
        </div>
        
        <div class="space-y-6">
          <h4 class="font-bold text-gray-900 uppercase tracking-widest text-[10px]">Ikuti Kami</h4>
          <div class="flex gap-4">
            <a href="https://www.instagram.com/morutha.id" target="_blank" rel="noopener noreferrer" class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-gray-400 hover:text-pink-500 transition-all hover:border-pink-500">
              <Instagram size={20} />
            </a>
            <a href="https://www.tiktok.com/@morutha" target="_blank" rel="noopener noreferrer" class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-gray-400 hover:text-black transition-all hover:border-black">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 8.5c0 .5-.5 1-1 1h-3c-.5 0-1-.5-1-1V5.5c0-.5.5-1 1-1h3c.5 0 1 .5 1 1v3z"/>
                <path d="M9 12a3 3 0 1 0 6 0 3 3 0 1 0-6 0z"/>
                <path d="M9 12V8.5c0-.5.5-1 1-1h4c.5 0 1 .5 1 1V12"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
      
      <div class="max-w-7xl mx-auto px-4 pt-10 border-t border-gray-100">
        <div class="flex flex-wrap justify-between gap-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">
          <p>Â© 2025 Morutha Kids Footwear. All rights reserved.</p>
          <div class="flex gap-8">
            <a href="#" class="hover:text-gray-900 transition-colors">Privasi</a>
            <a href="#" class="hover:text-gray-900 transition-colors">Syarat</a>
          </div>
        </div>
        <div class="text-center">
          <p class="text-[9px] text-gray-300 font-normal lowercase tracking-normal">
            Developed by <a href="https://landingo.id" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-[#00a8a8] transition-colors underline">Landingo</a>
          </p>
        </div>
      </div>
    </footer>

    <style>
      /* Hide scrollbar for color selector */
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
    </style>

    <script set:html={`window.__VARIANT_DATA__ = ${JSON.stringify(variantData)};
window.__SERIES_ID__ = '${series.id}';
window.__SELECTED_VARIANT_ID__ = '${selectedVariant.id}';`}></script>
    
    <script is:inline>
      (function() {
        // Get variant data from global
        const variantData = window.__VARIANT_DATA__ || [];
        const seriesId = window.__SERIES_ID__ || '';
        const initialVariantId = window.__SELECTED_VARIANT_ID__ || '';
        
        // Store all variant images in the DOM (hidden) for quick switching
        // Extract image URLs from existing images with data-variant-id attributes
        function getVariantImages(variantId) {
          const images = Array.from(document.querySelectorAll(`img[data-variant-id="${variantId}"]`));
          return images.map(img => ({
            src: img.src,
            alt: img.alt,
            element: img
          }));
        }
        
        // Initialize scroll animations
        function initScrollAnimations() {
          const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
          };

          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                entry.target.classList.add('visible');
              }
            });
          }, observerOptions);

          document.querySelectorAll('.fade-in').forEach(el => {
            observer.observe(el);
          });
        }

        // Color variant switching functionality
        let currentVariantId = initialVariantId;
        let currentImageIndex = 0;
        
        function switchColorVariant(variantId) {
          const variant = variantData.find(v => v.id === variantId);
          if (!variant) return;
          
          currentVariantId = variantId;
          currentImageIndex = 0;
          
          // Update color buttons (top selector)
          document.querySelectorAll('.color-variant-btn').forEach(btn => {
            const btnVariantId = btn.getAttribute('data-variant-id');
            if (btnVariantId === variantId) {
              btn.classList.add('border-[#00a8a8]', 'bg-teal-50', 'text-[#00a8a8]', 'font-bold', 'shadow-md', 'scale-105');
              btn.classList.remove('border-gray-200', 'text-gray-700');
            } else {
              btn.classList.remove('border-[#00a8a8]', 'bg-teal-50', 'text-[#00a8a8]', 'font-bold', 'shadow-md', 'scale-105');
              btn.classList.add('border-gray-200', 'text-gray-700');
            }
          });
          
          // Update gallery variant cards (bottom gallery)
          document.querySelectorAll('.variant-gallery-card').forEach(card => {
            const cardVariantId = card.getAttribute('data-variant-id');
            const selectedBadge = card.querySelector('.variant-selected-badge');
            
            if (cardVariantId === variantId) {
              card.classList.add('ring-2', 'ring-[#00a8a8]');
              // Show selected badge if not exists
              if (!selectedBadge) {
                const badge = document.createElement('div');
                badge.className = 'absolute top-3 right-3 bg-[#00a8a8] text-white text-xs font-bold px-2 py-1 rounded-full variant-selected-badge';
                badge.textContent = 'Dipilih';
                const imageContainer = card.querySelector('.aspect-square');
                if (imageContainer) imageContainer.appendChild(badge);
              }
            } else {
              card.classList.remove('ring-2', 'ring-[#00a8a8]');
              // Remove selected badge
              if (selectedBadge) {
                selectedBadge.remove();
              }
            }
          });
          
          // Update color info
          const colorNameEl = document.getElementById('selected-color-name');
          const colorCountEl = document.getElementById('selected-color-count');
          if (colorNameEl) colorNameEl.textContent = variant.name;
          if (colorCountEl) colorCountEl.textContent = variant.imageCount;
          
          // Show/hide main images based on variant
          const mainImages = Array.from(document.querySelectorAll('#main-image-container img'));
          mainImages.forEach(img => {
            const imgVariantId = img.getAttribute('data-variant-id');
            const imgIndex = parseInt(img.getAttribute('data-image-index') || '0');
            
            if (imgVariantId === variantId) {
              img.classList.remove('hidden');
              if (imgIndex === 0) {
                img.classList.remove('opacity-0', 'absolute');
                img.classList.add('opacity-100', 'relative');
              } else {
                img.classList.add('opacity-0', 'absolute');
                img.classList.remove('opacity-100', 'relative');
              }
            } else {
              img.classList.add('hidden');
            }
          });
          
          // Show/hide thumbnails based on variant
          const thumbnails = Array.from(document.querySelectorAll('.thumbnail-btn'));
          thumbnails.forEach(thumb => {
            const thumbVariantId = thumb.getAttribute('data-variant-id');
            if (thumbVariantId === variantId) {
              thumb.classList.remove('hidden');
            } else {
              thumb.classList.add('hidden');
            }
          });
          
          // Update thumbnail count
          const visibleThumbnails = thumbnails.filter(t => t.getAttribute('data-variant-id') === variantId);
          const thumbnailCountEl = document.getElementById('thumbnail-count');
          if (thumbnailCountEl) thumbnailCountEl.textContent = visibleThumbnails.length;
          
          // Show/hide thumbnail container
          const thumbnailContainer = document.getElementById('thumbnail-container');
          if (thumbnailContainer) {
            thumbnailContainer.style.display = visibleThumbnails.length > 1 ? 'block' : 'none';
          }
          
          // Reset to first image
          updateMainImage();
          updateThumbnailSelection();
          
          // Update URL without reload
          const newUrl = `/products/${seriesId}?color=${variantId}`;
          window.history.pushState({ variantId }, '', newUrl);
        }
        
        function initImageGallery() {
          // Initialize with current variant images
          const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
          if (images.length === 0) return;
          
          // Store reference for other functions
          window.currentImages = images;
        }
        
        function attachThumbnailHandlers() {
          // Remove old handlers and attach new ones
          document.querySelectorAll('.thumbnail-btn').forEach(thumb => {
            // Clone to remove old listeners
            const newThumb = thumb.cloneNode(true);
            thumb.parentNode?.replaceChild(newThumb, thumb);
            
            newThumb.addEventListener('click', function(e) {
              e.preventDefault();
              const variantId = this.getAttribute('data-variant-id');
              // Only process clicks for current variant
              if (variantId === currentVariantId) {
                const idx = parseInt(this.getAttribute('data-image-index') || '0');
                currentImageIndex = idx;
                updateMainImage();
                updateThumbnailSelection();
              }
            });
          });
        }

        const lightbox = document.getElementById('lightbox');
        const lightboxContainer = document.getElementById('lightbox-image-container');
        const lightboxClose = document.getElementById('lightbox-close');
        const lightboxPrev = document.getElementById('lightbox-prev');
        const lightboxNext = document.getElementById('lightbox-next');
        const lightboxTrigger = document.getElementById('lightbox-trigger');

        function updateMainImage() {
          // Only update images for current variant
          const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
          images.forEach((img, idx) => {
            if (idx === currentImageIndex) {
              img.classList.remove('opacity-0', 'absolute');
              img.classList.add('opacity-100', 'relative');
            } else {
              img.classList.add('opacity-0', 'absolute');
              img.classList.remove('opacity-100', 'relative');
            }
          });
        }

        function updateThumbnailSelection() {
          // Only update thumbnails for current variant
          const thumbnails = Array.from(document.querySelectorAll(`.thumbnail-btn[data-variant-id="${currentVariantId}"]`));
          thumbnails.forEach((thumb, idx) => {
            if (idx === currentImageIndex) {
              thumb.classList.add('ring-2', 'ring-[#00a8a8]');
            } else {
              thumb.classList.remove('ring-2', 'ring-[#00a8a8]');
            }
          });
        }
        
        // Color variant button handlers (top selector)
        document.querySelectorAll('.color-variant-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const variantId = this.getAttribute('data-variant-id');
            if (variantId && variantId !== currentVariantId) {
              switchColorVariant(variantId);
              // Scroll to top to see the main image
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });
        
        // Gallery variant card handlers (bottom gallery)
        document.querySelectorAll('.variant-gallery-card').forEach(card => {
          card.addEventListener('click', function(e) {
            e.preventDefault();
            const variantId = this.getAttribute('data-variant-id');
            if (variantId && variantId !== currentVariantId) {
              switchColorVariant(variantId);
              // Scroll to top to see the main image
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });

        // Lightbox functionality
        function attachLightboxHandlers() {
          const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
          if (lightboxTrigger && images.length > 0) {
            lightboxTrigger.onclick = function() {
              openLightbox();
            };
          }
        }

        function openLightbox() {
          if (!lightbox || !lightboxContainer) return;
          
          lightbox.classList.remove('hidden');
          lightbox.classList.add('flex');
          document.body.style.overflow = 'hidden';
          updateLightboxImage();
        }

        function closeLightbox() {
          if (!lightbox) return;
          lightbox.classList.add('hidden');
          lightbox.classList.remove('flex');
          document.body.style.overflow = '';
        }

        function updateLightboxImage() {
          if (!lightboxContainer) return;
          const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
          if (images.length === 0) return;
          
          const currentImg = images[currentImageIndex];
          if (currentImg) {
            lightboxContainer.innerHTML = `
              <img src="${currentImg.src}" alt="${currentImg.alt}" class="max-w-full max-h-full object-contain" />
            `;
          }
        }

        if (lightboxClose) {
          lightboxClose.addEventListener('click', closeLightbox);
        }

        if (lightboxPrev) {
          lightboxPrev.addEventListener('click', function() {
            const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
            if (images.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            updateMainImage();
            updateThumbnailSelection();
            updateLightboxImage();
          });
        }

        if (lightboxNext) {
          lightboxNext.addEventListener('click', function() {
            const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
            if (images.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % images.length;
            updateMainImage();
            updateThumbnailSelection();
            updateLightboxImage();
          });
        }

        // Close lightbox on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && lightbox && !lightbox.classList.contains('hidden')) {
            closeLightbox();
          }
          if (e.key === 'ArrowLeft' && lightbox && !lightbox.classList.contains('hidden')) {
            const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
            if (images.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            updateMainImage();
            updateThumbnailSelection();
            updateLightboxImage();
          }
          if (e.key === 'ArrowRight' && lightbox && !lightbox.classList.contains('hidden')) {
            const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
            if (images.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % images.length;
            updateMainImage();
            updateThumbnailSelection();
            updateLightboxImage();
          }
        });

        // Close lightbox when clicking outside image
        if (lightbox) {
          lightbox.addEventListener('click', function(e) {
            if (e.target === lightbox) {
              closeLightbox();
            }
          });
        }

        // Mobile swipe gestures for image carousel
        let touchStartX = 0;
        let touchEndX = 0;

        function attachSwipeHandlers() {
          const mainImageContainer = document.getElementById('main-image-container');
          if (!mainImageContainer) return;
          
          const images = Array.from(document.querySelectorAll('#main-image-container img'));
          if (images.length <= 1) return;
          
          mainImageContainer.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
          });

          mainImageContainer.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
          });

          function handleSwipe() {
            const images = Array.from(document.querySelectorAll(`#main-image-container img[data-variant-id="${currentVariantId}"]`));
            if (images.length === 0) return;
            
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
              if (diff > 0) {
                // Swipe left - next image
                currentImageIndex = (currentImageIndex + 1) % images.length;
              } else {
                // Swipe right - previous image
                currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
              }
              updateMainImage();
              updateThumbnailSelection();
            }
          }
        }

        // Initialize
        function initialize() {
          initScrollAnimations();
          initImageGallery();
          attachThumbnailHandlers();
          attachLightboxHandlers();
          attachSwipeHandlers();
          updateMainImage(); // Ensure main image is set correctly on initial load
          updateThumbnailSelection();
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initialize);
        } else {
          initialize();
        }
      })();
    </script>
  </body>
</html>
